---
description: 거래소로부터 받은 차트 데이터도 Query Mapping 을 사용하여 차트에 적용하여 간결한 구현이 가능합니다.
---

# 7. CandleChart 적용

### 1. 준비및 화면 작업 (MainView.lay)

이전 프로젝트에서 계속 진행합니다 [3.-grid-mapping-websocket.md](3.-grid-mapping-websocket.md "mention")



* FrameWork 추가
  * CandleChart 를 사용하기 위해서는 Stock Framework 를 추가해야 합니다.

<figure><img src="../../.gitbook/assets/image (185).png" alt=""><figcaption></figcaption></figure>



* CandleChart Componnet 추가
  * 이전프로젝트 화면에서 CandleChart Component 를 추가하고 ID 를 candleChart 로 설정합니다.

<figure><img src="../../.gitbook/assets/image (186).png" alt=""><figcaption></figcaption></figure>

* Grid 선택 이벤트 추가
  * Grid 내 종목을 선택했을경우 Candle Chart 가 표시될수 있도록 이벤트를 추가합니다

<figure><img src="../../.gitbook/assets/image (4) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>



### 2. Query 추가및 생성

* rest\_minute.qry 생성 (추가방법은 이전 프로젝트 예제 참고)
  * 종목 리스트에서 종목 선택시 Candle Chart 에 적용될 data mapping
  * 1분차트 예시로 진행

code:

```json
{
	"desc": "최근 체결 내역",
	"queryType": "쿼리 타입",
	"name": "rest_minutes",
	"url": "candles/minutes/1",
	"input": {
		"InBlock1": {
			"format": [
				["종목 코드","market","","","char",1,0],
				["마지막 체결 시각","to","","","char",1,0],
				["캔들 개수(최대 200개)","count","","","signed",1,0]
			]
		}
	},
	"output": {
		"OutBlock1": {
			"format": [
                ["종목 코드","market","","","char",0,0],
                ["캔들 기준 시각(UTC 기준)","candle_date_time_utc","","","char",0,0],
                ["캔들 기준 시각(KST 기준)","candle_date_time_kst","","","char",0,0],	
                ["시가","opening_price","","","signed",0,0],
                ["고가","high_price","","","signed",0,0],
                ["저가","low_price","","","signed",0,0],
                ["종가","trade_price","","","signed",0,0],
                ["마지막 틱 시각","timestamp","","","char",0,0],
                ["누적 거래 금액","candle_acc_trade_price","","","signed",0,0],
                ["누적 거래량","candle_acc_trade_volume","","","signed",0,0],
                ["분 단위(유닛)","unit","","","char",0,0]
			]
		}
	}
}
```

* 기존 ticker.py  에데이터 추가&#x20;
  * 종목 데이터 외에 Candle 차트 업데이트에 필요한 데이터 추가

code:

```json
{
	"desc": "현재가",
	"queryType": "쿼리 타입",
	"name": "ticker",
	"input": {
		"InBlock1": {
			"format": [
				["market 코드","codes","","","char",1,0]
			]
		}
	},
	"output": {
		"OutBlock1": {
			"format": [
				["시장코드","market","","","char",9,0],
				["마켓 코드","cd","","","char",0,0],
				["현재가","tp","","","char",0,0],
				["전일 대비 값","scp","","","char",0,0],
				["24시간 누적 거래대금","atp24h","","","char",0,0],
		                ["시가","op","","","char",0,0],
				["고가","hp","","","char",0,0],
				["저가","lp","","","char",0,0],
                		["현재가","tp","","","char",0,0],
		                ["가장 최근 거래량","tv","","","char",0,0]                
			]
		}
	}
}
```

### 3. Query Mapping&#x20;

CandleChart 에 Query 를   Mapping 합니다.

* rest\_minutes.qry&#x20;
  * 분봉 쿼리 Data 를 Mapping 합니다
    * 1-  빈필드(dataStr)
      * 1번 row 는 중앙의userField  로 생성하고 변수명을 dataStr 로 설정
      * 코드에서 값을 설정하는 Field.
      * 처음에 추가가 안되면 2번 row 부터 mapping 한다음 제일 마지막에 진행합니다.
    * 2- 시가 (opening\_price)
    * 3-고가 (high\_price)
    * 4-저가(low\_price)
    * 5-종가(trade\_price)
    * 6-누적거래량(candle\_acc\_trade\_price)
    * 7-누적거래금액(candle\_acc\_trade\_volume)

<figure><img src="../../.gitbook/assets/image (6) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>



* ticker. qry
  * 실시간으로 변하는 Candle Data 를 추가로 mapping
  * 1- 빈필드(DummyField)
  * 2-시가(op)
  * 3-고가(hp)
  * 4-저가(lp)
  * 5-현재가(tp)
  * 6-가장최근거래량(tv)

<figure><img src="../../.gitbook/assets/image (7) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>



### 3. 코드 수정 (MainView.js)

* 초기화 코드 수정
  * marketCode  멤버변수 추가

code:

```javascript
onInitDone()
{
        super.onInitDone()

        this.qmRest = new RestQueryManager('REST');
	this.qmRest.setNetworkIo(new UbHttpIO(this.qmRest));
	this.qmRest.setTimeout(Define.TIMEOUT_SEC);

        this.qmReal = new RealQueryManager('REAL', this);
        this.nio = new WebsocketIO(this.qmReal, true);
        this.qmReal.setNetworkIo(this.nio);

        this.marketCode = null;
}
```



* 종목 선택 이벤트 추가
  * 종목을 선택하면 Chart 데이터를 요청하여 CandleChart 에 적용.

```javascript

onDataGridSelect(comp, info, e)
{   
    const selData = comp.getSelectedData();
    const marketCode = selData[0].text;

    (async()=>{
        
        // 기존 업데이트 대상 취소처리
        if(this.marketCode)
        {
            this.qmReal.unregisterReal('ticker', [this.marketCode], [this.candleChart]);
        }

        await this.updateChart(marketCode);
        this.marketCode = marketCode;
    })();         
}

updateChart(marketCode)
{
    this.candleChart.resetData();

    const thisMarketCode = marketCode;

    this.qmRest.sendProcessByName('rest_minutes', this.getContainerId(), null, queryData=>
    {
        const inBlock = queryData.getBlockData('InBlock1')[0];
        inBlock.market = thisMarketCode;
        inBlock.count = 200;
    }, queryData =>{
        const outBlock = queryData.getBlockData('OutBlock1');
        if(!outBlock.length)
        {
            this.candleChart.nextIqryData = null;
            return;
        }

        for(let block of outBlock)
        {
            block.dateStr = block.candle_date_time_kst.replace(/[^0-9]/g, '').substring(0,8);
        }
            
        this.candleChart.nextIqryDate = outBlock[outBlock.length-1].candle_date_time_utc;

        // 새로운 실시간 업데이트 처리
        this.qmReal.registerReal('ticker', 'cd', [thisMarketCode], [this.candleChart], 0, queryData => {
                    let data = queryData.getBlockData('OutBlock1')[0];
                    data.DummyField = new Date(data.tms).format('yyyyMMdd');
            });
        });
    }
```





### 4. 결과 확인

* 겨래소 연결후, 선택된 종목의 Candle Chart 가 표시되는지 확인.

<figure><img src="../../.gitbook/assets/image (8) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>



Download

{% file src="../../.gitbook/assets/WTSSample (2).zip" %}

